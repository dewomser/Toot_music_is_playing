#!/bin/bash
#//config

BASEDIR=$(readlink -f "$0" | xargs dirname)
function urldecode() { : "${*//+/ }"; echo -e "${_//%/\\x}"; }
clementine="$(qdbus org.mpris.MediaPlayer2.clementine /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.PlaybackStatus)"
vlc="$(qdbus org.mpris.MediaPlayer2.vlc /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.PlaybackStatus)"
plasma="$(qdbus org.mpris.MediaPlayer2.plasma-browser-integration /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.PlaybackStatus)"
elisa="$(qdbus org.mpris.MediaPlayer2.elisa /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.PlaybackStatus)"

if [ "$clementine" == "Playing" ]
then
player=clementine
elif [ "$vlc" == "Playing" ]
then
 player=vlc
elif [ "$elisa" == "Playing" ]
then
 player=elisa
elif [ "$plasma" == "Playing" ]
then
 player="plasma-browser-integration"
else
  exit
fi

if [ "$player" == "plasma-browser-integration" ]
then
lolo3="wget $(qdbus org.mpris.MediaPlayer2.$player /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Metadata | grep -E artUrl | sed -e 's/mpris:artUrl://g')"
$lolo3 -O cover.jpg
a[0]=cover.jpg
else
a[0]="$(qdbus org.mpris.MediaPlayer2.$player /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Metadata | grep -E artUrl | sed -e 's/mpris:artUrl: file:\/\///g')"
if [ -z "${a[0]}" ]; then  a[0]="nocover.jpg"; fi
fi
a[1]="$(qdbus org.mpris.MediaPlayer2.$player /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Metadata | grep -E artist | sed -e 's/xesam://g')"
if [ -z "${a[1]}" ]; then  a[1]="ohne"; fi

a[2]="$(qdbus org.mpris.MediaPlayer2.$player /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Metadata | grep -E album: | sed -e 's/xesam://g')"
if [ -z "${a[2]}" ]; then  a[2]="ohne"; fi

a[4]="$(qdbus org.mpris.MediaPlayer2.$player /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Metadata | grep -E title: | sed -e 's/xesam://g')"
if [ -z "${a[4]}" ]; then  a[4]="ohne"; fi
lolo1=$(urldecode "${a[0]}")
convert "$lolo1" -gravity south   -background YellowGreen  -splice 0x18 -annotate +0+2 'Die Tweet_Music-App ist vom @dewomser' "$BASEDIR"/cover.jpg

#// readarray -t a <<< "$(qdbus org.mpris.MediaPlayer2.$player /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Metadata | grep -E 'artUrl|genre|artist|album:|title:'| sed -e 's/xesam://g'| sed -e 's/mpris:artUrl:[[:space:]]file:\/\///g')"
#a[5]="https://www.youtube.com/results?search_query=${a[2]} ${a[4]}"
#lolo=${a[5]// /+}

#olo1=$(urldecode "${a[0]}")
#cp "$lolo1" "$PWD"/cover.jpg

a[5]="https://www.youtube.com/results?search_query=${a[2]} ${a[4]}"
lolo="${a[5]// /+}"
text1=$"ich höre gerade:"
text="$text1
${a[4]}
${a[2]}
${a[1]}
Audio-player:$player
Video(geraten):$lolo"
#echo -e "Ich höre gerade \n${a[4]}\n${a[2]}\n${a[1]}\n${a[3]}\nAudio-player:$player\nVideo(geraten):$lolo"
#| toot post --media "cover.jpg"
echo "$text" | toot post --media "cover.jpg"
